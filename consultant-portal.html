<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Student Dashboard</title>
<!-- Stylesheets -->
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/style.css" rel="stylesheet">
<link href="css/fontawesome.css" rel="stylesheet">
<!-- Dark Mode Stylesheet -->
<link href="css/style-dark.css" rel="stylesheet" id="dark-theme-style" disabled>

<link rel="shortcut icon" href="images/favicon-16x16.png" type="image/x-icon">
<link rel="icon" href="images/favicon-16x16.png" type="image/x-icon">

<!-- Responsive -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<!--[if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script><![endif]-->
<!--[if lt IE 9]><script src="js/respond.js"></script><![endif]-->

<!-- Custom CSS for Theme Toggle Button & Portal -->
<style>
	.theme-toggle-btn {
		background-color: transparent;
		border: 1px solid #e1e6dc;
		color: #015cb5;
		width: 40px;
		height: 40px;
		border-radius: 50%;
		font-size: 18px;
		cursor: pointer;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		transition: all 300ms ease;
		margin-left: 10px;
	}
	.theme-toggle-btn:hover {
		background-color: #015cb5;
		color: #ffffff;
		border-color: #015cb5;
	}
	body.dark-mode .theme-toggle-btn {
		background-color: transparent;
		border-color: #ffffff;
		color: #ffffff;
	}
    body.dark-mode .theme-toggle-btn:hover {
		background-color: #ffffff;
		color: #171717;
	}

    /* Portal Styles */
    .student-portal {
        display: flex;
        background-color: #f0f5fb;
    }
    body.dark-mode .student-portal {
        background-color: var(--dark-color1);
    }

    .portal-sidebar {
        width: 280px;
        background-color: var(--theme-color1);
        color: #fff;
        padding: 20px;
        height: 100vh;
        position: fixed; 
        top: 0;
        left: 0;
        overflow-y: auto;
        padding-top: 155px; /* Pushed down to avoid header */
    }
    body.dark-mode .portal-sidebar {
        background-color: #1e2434;
    }

    .student-profile {
        text-align: center;
        margin-bottom: 30px;
    }
    .student-profile img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 3px solid var(--theme-color2);
        margin-bottom: 10px;
    }
    .student-profile h5 {
        margin: 0;
        font-weight: 600;
        color: #fff;
    }
    .student-profile p {
        font-size: 14px;
        color: #ccc;
        word-break: break-all;
    }

    .portal-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .portal-nav li a {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    .portal-nav li a:hover,
    .portal-nav li.active a {
        background-color: var(--theme-color2);
    }
    .portal-nav li a i {
        margin-right: 15px;
        width: 20px;
        text-align: center;
    }

    .portal-content {
        flex: 1;
        padding: 40px;
        margin-left: 280px;
        margin-top: 135px; /* Added margin to clear fixed header */
    }
    .portal-content-section {
        display: none;
    }
    .portal-content-section.active {
        display: block;
    }
    .portal-card {
        background: #fff;
        border-radius: 8px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }
    body.dark-mode .portal-card {
        background-color: var(--dark-color2);
    }
    .portal-card h4, .portal-card h5 {
        display: flex;
        align-items: center;
        font-size: 20px;
        margin-bottom: 15px;
    }
     .portal-card h5 {
        font-size: 18px;
        margin-top: 30px;
     }
    .portal-card h4 i {
        font-size: 24px;
        margin-right: 15px;
        color: var(--theme-color2);
    }
    .notice-item {
        display: flex;
        align-items: center;
    }
    .notice-item i {
        color: var(--theme-color3);
        margin-right: 10px;
    }
    .data-form .form-group {
        margin-bottom: 20px;
    }
    .data-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
    }
    .data-form .form-control {
        height: 50px;
        border-radius: 5px;
        border: 1px solid #ddd;
        padding: 10px 20px;
        width: 100%;
    }
    body.dark-mode .data-form .form-control {
        background-color: var(--dark-color1);
        border-color: #444;
        color: #fff;
    }
    .input-group {
        display: flex;
    }
    .input-group .form-control {
        flex: 1;
    }
    .input-group select {
        max-width: 150px;
        border-right: 0;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    .document-upload-item {
        padding-bottom: 15px;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    body.dark-mode .document-upload-item {
        border-bottom-color: #444;
    }
    .document-upload-item:last-child {
        border-bottom: none;
    }
    .upload-area {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .upload-area .form-control {
        flex: 1;
    }
    .uploaded-file-link {
        display: block;
        margin-top: 10px;
        font-weight: 500;
    }
</style>

</head>

<body>

<div class="page-wrapper">

	<!-- Preloader -->
	<div class="preloader"></div>

	<!-- Main Header-->
	<header class="main-header header-style-one" style="position: fixed; width: 100%; top: 0; z-index: 1000;">
		<!-- Header Top -->
		<div class="header-top">
			<div class="inner-container">

				<div class="top-left">
					<!-- Info List -->
					<ul class="list-style-one">
						<li><i class="fa fa-envelope"></i> <a href="mailto:support@kuroeduconsultancy.com">support@kuroeduconsultancy.com</a></li>
						<li><i class="fa fa-map-marker"></i> 3rd Floor George Silundika Avenue, Harare</li> 
						<li><i class="fa fa-clock"></i> Mon_Fri: 8.00 to 16.00</li> 
					</ul>
				</div>
				
				<div class="top-right">
					<ul class="useful-links">
						<li><a href="#">Help</a></li>
						<li><a href="#">Support</a></li>
						<li><a href="#">Contact</a></li>
					</ul>
				</div>
			</div>
		</div>
		<!-- Header Top -->

		<!-- Header Lower -->
		<div class="header-lower">
			<!-- Main box -->
			<div class="main-box">
				<div class="logo-box">
					<div class="logo"><a href="index.html"><img src="images/LOGO.png" alt="Kuro Logo" title=""></a></div>
				</div>

				<!--Nav Box-->
				<div class="nav-outer">
					
					<nav class="nav main-menu">
						<ul class="navigation">
							<li><a href="index.html">Home</a></li>
							<li><a href="page-country.html">Country</a></li>
							<li class="dropdown"><a href="page-service.html">Visa</a>
								<ul>
									<li><a href="page-service.html">Visa Grid</a></li>
									<li><a href="page-service-details.html">Visa Details</a></li>
								</ul>
							</li>
							<li><a href="page-contact.html">Contact</a></li>
							<li><a href="page-about.html">About</a></li>
                            <li class="current"><a href="student-portal.html">Student Portal</a></li>
						</ul>
					</nav>
					<!-- Main Menu End-->

					<div class="outer-box">                        
						<a href="tel:+48783042776" class="info-btn">
							<img src="images/icons/icon-phone.png" alt="" class="icon">
							<small>Call Anytime</small> 
							<strong>+48 783 042 776</strong>
						</a>

						<div class="ui-btn-outer">
							<button class="ui-btn ui-btn search-btn">
								<span class="icon lnr lnr-icon-search"></span>
							</button>
						</div>

						<!-- THEME TOGGLE BUTTON ADDED -->
						<button class="theme-toggle-btn" id="theme-toggler" title="Toggle Night Mode">
							<i class="fa fa-moon"></i>
						</button>

						<a href="https://calendly.com/kuroeducationalconsultancy/30min" class="theme-btn btn-style-one"><span class="btn-title">Book Consultation</span></a>

						<!-- Mobile Nav toggler -->
						<div class="mobile-nav-toggler"><span class="icon lnr-icon-bars"></span></div>
					</div>
				</div>
			</div>
		</div>
		<!-- End Header Lower -->

		<!-- Mobile Menu  -->
		<div class="mobile-menu">
			<div class="menu-backdrop"></div>
		
			<!--Here Menu Will Come Automatically Via Javascript / Same Menu as in Header-->
			<nav class="menu-box">
				<div class="upper-box">
					<div class="nav-logo"><a href="index.html"><img src="images/LOGO.png" alt="Kuro Logo" title=""></a></div>
					<div class="close-btn"><i class="icon fa fa-times"></i></div>
				</div>
		
				<ul class="navigation clearfix">
					<!--Keep This Empty / Menu will come through Javascript-->
				</ul>
				<ul class="contact-list-one">
					<li>
						<!-- Contact Info Box -->
						<div class="contact-info-box">
							<i class="icon lnr-icon-phone-handset"></i>
							<span class="title">Call Now</span>
							<a href="tel:+48783042776">+48 783 042 776</a>
						</div>
					</li>
					<li>
						<!-- Contact Info Box -->
						<div class="contact-info-box">
							<span class="icon lnr-icon-envelope1"></span>
							<span class="title">Send Email</span>
							<a href="mailto:support@kuroeduconsultancy.com">support@kuroeduconsultancy.com</a>
						</div>
					</li>
					<li>
						<!-- Contact Info Box -->
						<div class="contact-info-box">
							<span class="icon lnr-icon-clock"></span>
							<span class="title">Send Email</span>
							Mon - Sat 8:00 - 6:30, Sunday - CLOSED
						</div>
					</li>
				</ul>
		
		
				<ul class="social-links">
					<li><a href="#"><i class="fab fa-twitter"></i></a></li>
					<li><a href="#"><i class="fab fa-facebook-f"></i></a></li>
					<li><a href="#"><i class="fab fa-pinterest"></i></a></li>
					<li><a href="#"><i class="fab fa-instagram"></i></a></li>
				</ul>
			</nav>
		</div><!-- End Mobile Menu -->

		<!-- Header Search -->
		<div class="search-popup">
			<span class="search-back-drop"></span>
			<button class="close-search"><span class="fa fa-times"></span></button>
		
			<div class="search-inner">
				<form method="post" action="index.html">
					<div class="form-group">
						<input type="search" name="search-field" value="" placeholder="Search..." required="">
						<button type="submit"><i class="fa fa-search"></i></button>
					</div>
				</form>
			</div>
		</div>
		<!-- End Header Search -->

		<!-- Sticky Header  -->
		<div class="sticky-header">
			<div class="auto-container">
				<div class="inner-container">
					<!--Logo-->
					<div class="logo">
						<a href="index.html" title=""><img src="images/LOGO.png" alt="Kuro Logo" title=""></a>
					</div>
		
					<!--Right Col-->
					<div class="nav-outer">
						<!-- Main Menu -->
						<nav class="main-menu">
							<div class="navbar-collapse show collapse clearfix">
								<ul class="navigation clearfix">
									<!--Keep This Empty / Menu will come through Javascript-->
								</ul>
							</div>
						</nav><!-- Main Menu End-->
		
						<!--Mobile Navigation Toggler-->
						<div class="mobile-nav-toggler"><span class="icon lnr-icon-bars"></span></div>
					</div>
				</div>
			</div>
		</div><!-- End Sticky Menu -->
	</header>
	<!--End Main Header -->

    <!-- Student Portal Section -->
    <div class="student-portal">
        <aside class="portal-sidebar">
            <div class="student-profile">
                <img src="https://placehold.co/100x100/015cb5/ffffff?text=User" alt="Student Photo">
                <h5 id="user-display-name">Student Profile</h5>
                <p id="user-email"></p>
            </div>
            <nav class="portal-nav">
                <ul>
                    <li class="active"><a href="#" data-target="main-page"><i class="fa fa-home"></i> Main page</a></li>
                    <li><a href="#" data-target="my-data"><i class="fa fa-user"></i> My Data</a></li>
                    <li><a href="#" data-target="course-study-section"><i class="fa fa-graduation-cap"></i> Course of Study</a></li>
                    <li><a href="#" data-target="documents-section"><i class="fa fa-folder-open"></i> Documents</a></li>
                    <li><a href="#"><i class="fa fa-bell"></i> Notices</a></li>
                    <li><a href="#"><i class="fa fa-key"></i> Change Password</a></li>
                    <li><a href="#" id="logout-btn"><i class="fa fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </nav>
        </aside>

        <main class="portal-content">
            <!-- Main Page Content -->
            <div id="main-page" class="portal-content-section active">
                <div class="portal-card">
                    <h4><i class="fa fa-graduation-cap"></i> Welcome to the Student Dashboard</h4>
                    <p>This application presents all the information about your application and university.</p>
                </div>

                <div class="portal-card">
                    <h4><i class="fa fa-bell"></i> Notices</h4>
                    <div class="notice-item">
                        <i class="fa fa-exclamation-triangle"></i>
                        <p>Request to update students' residence addresses.</p>
                    </div>
                </div>
            </div>

            <!-- My Data Content -->
            <div id="my-data" class="portal-content-section">
                <div class="portal-card">
                    <h4><i class="fa fa-user"></i> My Data</h4>
                    <form id="my-data-form" class="data-form">
                        <h5>Personal Information</h5>
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="first-name">First Name</label>
                                <input type="text" id="first-name" class="form-control" required>
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="surname">Surname</label>
                                <input type="text" id="surname" class="form-control" required>
                            </div>
                            <div class="col-12" id="middle-names-container">
                                <!-- Middle name inputs will be added here by JS -->
                            </div>
                            <div class="col-12 form-group">
                                <button type="button" id="add-middle-name-btn" class="theme-btn btn-style-one small" style="padding: 5px 15px; font-size: 12px; background-color: var(--theme-color3);">Add Middle Name</button>
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" class="form-control">
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="dob">Date of Birth</label>
                                <input type="date" id="dob" class="form-control">
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="nationality">Nationality</label>
                                <select id="nationality" class="form-control"></select>
                            </div>
                             <div class="col-md-6 form-group">
                                <label for="passport-number">Passport Number</label>
                                <input type="text" id="passport-number" class="form-control">
                            </div>
                             <div class="col-12 form-group">
                                <label for="phone-number">Phone Number</label>
                                <div class="input-group">
                                    <select id="country-code" class="form-control"></select>
                                    <input type="tel" id="phone-number" class="form-control">
                                </div>
                            </div>
                        </div>
                        
                        <h5 style="margin-top: 30px;">Address Information</h5>
                        <div class="row">
                             <div class="col-12 form-group">
                                <label for="address-line1">Address Line 1 (Mandatory)</label>
                                <input type="text" id="address-line1" class="form-control" required>
                            </div>
                             <div class="col-12 form-group">
                                <label for="address-line2">Address Line 2 (Optional)</label>
                                <input type="text" id="address-line2" class="form-control">
                            </div>
                             <div class="col-md-6 form-group">
                                <label for="city">City (Mandatory)</label>
                                <input type="text" id="city" class="form-control" required>
                            </div>
                             <div class="col-md-6 form-group">
                                <label for="state-province">State / Province (Mandatory)</label>
                                <input type="text" id="state-province" class="form-control" required>
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="zip-code">Zip / Postal Code (Optional)</label>
                                <input type="text" id="zip-code" class="form-control">
                            </div>
                             <div class="col-md-6 form-group">
                                <label for="country">Country (Mandatory)</label>
                                <select id="country" class="form-control" required></select>
                            </div>
                        </div>
                        <button type="submit" class="theme-btn btn-style-one" style="margin-top: 20px;"><span class="btn-title">Save Information</span></button>
                    </form>
                </div>
            </div>

            <!-- Course of Study Section -->
            <div id="course-study-section" class="portal-content-section">
                <div class="portal-card">
                    <h4><i class="fa fa-graduation-cap"></i> Course of Study</h4>
                    <form id="course-study-form" class="data-form">
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="university">Desired University</label>
                                <input type="text" id="university" class="form-control">
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="program">Desired Program / Major</label>
                                <input type="text" id="program" class="form-control">
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="study-level">Level of Study</label>
                                <select id="study-level" class="form-control">
                                    <option value="bachelors">Bachelors</option>
                                    <option value="masters">Masters</option>
                                </select>
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="intake">Preferred Intake</label>
                                <input type="text" id="intake" class="form-control" placeholder="e.g., Fall 2025">
                            </div>
                             <div class="col-md-6 form-group">
                                <label for="application-status">Application Status</label>
                                <select id="application-status" class="form-control">
                                    <option value="not_started">Not Started</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="submitted">Submitted</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="theme-btn btn-style-one" style="margin-top: 20px;"><span class="btn-title">Save Course Information</span></button>
                    </form>
                </div>
            </div>

            <!-- Documents Content -->
            <div id="documents-section" class="portal-content-section">
                <div class="portal-card">
                    <h4><i class="fa fa-folder-open"></i> Required Documents</h4>
                    <p>Please upload all the necessary documents for your application below.</p>
                    
                    <div class="document-upload-item" data-category="identity" data-doc-name="passport_scan">
                        <strong>International Passport Scan</strong>
                        <div class="upload-area mt-2">
                            <input type="file" class="form-control">
                            <button class="theme-btn btn-style-one small">Upload</button>
                        </div>
                        <div class="uploaded-file-list mt-2"></div>
                    </div>

                    <div class="document-upload-item" data-category="academic" data-doc-name="bachelor_diploma">
                        <strong>Bachelor Diploma (if available)</strong>
                        <div class="upload-area mt-2">
                            <input type="file" class="form-control">
                            <button class="theme-btn btn-style-one small">Upload</button>
                        </div>
                        <div class="uploaded-file-list mt-2"></div>
                    </div>

                    <div class="document-upload-item" data-category="academic" data-doc-name="high_school_certs">
                        <strong>High School Graduation & O/A Level Certificates</strong>
                        <div class="upload-area mt-2">
                            <input type="file" class="form-control">
                            <button class="theme-btn btn-style-one small">Upload</button>
                        </div>
                        <div class="uploaded-file-list mt-2"></div>
                    </div>

                    <div class="document-upload-item" data-category="language" data-doc-name="language_cert">
                        <strong>Language Certificate</strong>
                        <div class="upload-area mt-2">
                            <input type="file" class="form-control">
                            <button class="theme-btn btn-style-one small">Upload</button>
                        </div>
                        <div class="uploaded-file-list mt-2"></div>
                    </div>

                    <div class="document-upload-item" data-category="additional" data-doc-name="additional_docs">
                        <strong>Additional Documents</strong>
                        <div class="upload-area mt-2">
                            <input type="file" class="form-control">
                            <button class="theme-btn btn-style-one small">Upload</button>
                        </div>
                        <div class="uploaded-file-list mt-2"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

</div><!-- End Page Wrapper -->


<!-- Scroll To Top -->
<div class="scroll-to-top scroll-to-target" data-target="html"><span class="fa fa-angle-up"></span></div>


<script src="js/jquery.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.fancybox.js"></script>
<script src="js/jquery-ui.js"></script>
<script src="js/wow.js"></script>
<script src="js/appear.js"></script>
<script src="js/select2.min.js"></script>
<script src="js/swiper.min.js"></script>
<script src="js/owl.js"></script>
<script src="js/script.js"></script>
<script src="js/data.js"></script>  <!-- Added data script -->

<!-- Firebase SDK -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    getDoc,
    setDoc,
    collection,
    query,
    where,
    getDocs,
    addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBsvSje_UwItSMftbiLVt6Sh1wRR6fF7A0",
    authDomain: "kuroeduportal.firebaseapp.com",
    projectId: "kuroeduportal",
    storageBucket: "gs://kuroeduportal.firebasestorage.app",
    messagingSenderId: "677775001653",
    appId: "1:677775001653:web:8feb2559b811182a52097c",
    measurementId: "G-4JM8RWQDTW"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore(app);
  const storage = getStorage();

  // Get DOM Elements
  const logoutBtn = document.getElementById('logout-btn');
  const userDisplayName = document.getElementById('user-display-name');
  const userEmail = document.getElementById('user-email');
  const myDataForm = document.getElementById('my-data-form');
  const courseStudyForm = document.getElementById('course-study-form');
  const addMiddleNameBtn = document.getElementById('add-middle-name-btn');
  const middleNamesContainer = document.getElementById('middle-names-container');
  
  let currentUser = null;
  const allowedAgentEmail = "kuro.agents@kuroeduconsultancy.com";

  // Helper function to safely set values
function setValue(id, value) {
  const el = document.getElementById(id);
  if (el) el.value = value || '';
}

// Auth State Observer
document.addEventListener("DOMContentLoaded", () => {
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      if (user.email === allowedAgentEmail) {
        signOut(auth);
        window.location.href = 'agent-login.html';
        return;
      }
      currentUser = user;
      userEmail.textContent = user.email;
      await loadUserData();
    } else {
      window.location.href = 'student-portal.html';
    }
  });
});

  async function loadUserData() {
  const userDocRef = doc(db, "users", currentUser.uid);
  const userDoc = await getDoc(userDocRef);
  if (userDoc.exists()) {
    const userData = userDoc.data();
    
    if (userDisplayName) {
      userDisplayName.textContent = userData.firstName ? `${userData.firstName} ${userData.surname}` : userData.email;
    }

    // Helper function
    function safeSetValue(id, value) {
      const el = document.getElementById(id);
      if (el) {
        el.value = value || '';
      } else {
        console.warn(`Element with ID '${id}' not found.`);
      }
    }
        // Populate "My Data" form
        document.getElementById('first-name').value = userData.firstName || '';
        document.getElementById('surname').value = userData.surname || '';
        document.getElementById('email').value = userData.email || '';
        document.getElementById('dob').value = userData.dob || '';
        document.getElementById('nationality').value = userData.nationality || '';
        document.getElementById('passport-number').value = userData.passportNumber || '';
        document.getElementById('phone-number').value = userData.phoneNumber || '';
        document.getElementById('country-code').value = userData.countryCode || '';
        document.getElementById('address-line1').value = userData.addressLine1 || '';
        document.getElementById('address-line2').value = userData.addressLine2 || '';
        document.getElementById('city').value = userData.city || '';
        document.getElementById('state-province').value = userData.stateProvince || '';
        document.getElementById('zip-code').value = userData.zipCode || '';
        document.getElementById('country').value = userData.country || '';
        document.getElementById('high-school').value = userData.highSchool || '';
        document.getElementById('hs-graduation-date').value = userData.hsGraduationDate || '';
        
        // Populate "Course of Study" form
        document.getElementById('university').value = userData.university || '';
        document.getElementById('program').value = userData.program || '';
        document.getElementById('study-level').value = userData.studyLevel || 'bachelors';
        document.getElementById('intake').value = userData.intake || '';
        document.getElementById('application-status').value = userData.applicationStatus || 'not_started';

        if(userData.middleNames && Array.isArray(userData.middleNames)) {
            middleNamesContainer.innerHTML = ''; // Clear existing
            userData.middleNames.forEach(name => addMiddleNameInput(name));
        }
      }
  }

  // Logout button event listener
  logoutBtn.addEventListener('click', (e) => {
    e.preventDefault();
    signOut(auth).catch((error) => console.error('Sign out error:', error));
  });

  // Save "My Data" form
  myDataForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return;

    const middleNames = Array.from(document.querySelectorAll('.middle-name-input')).map(input => input.value).filter(Boolean);

    const userData = {
        firstName: document.getElementById('first-name').value,
        surname: document.getElementById('surname').value,
        middleNames: middleNames,
        email: document.getElementById('email').value,
        dob: document.getElementById('dob').value,
        nationality: document.getElementById('nationality').value,
        passportNumber: document.getElementById('passport-number').value,
        countryCode: document.getElementById('country-code').value,
        phoneNumber: document.getElementById('phone-number').value,
        addressLine1: document.getElementById('address-line1').value,
        addressLine2: document.getElementById('address-line2').value,
        city: document.getElementById('city').value,
        stateProvince: document.getElementById('state-province').value,
        zipCode: document.getElementById('zip-code').value,
        country: document.getElementById('country').value,
        highSchool: document.getElementById('high-school').value,
        hsGraduationDate: document.getElementById('hs-graduation-date').value
    };

    try {
        await setDoc(doc(db, "users", currentUser.uid), userData, { merge: true });
        alert('Your information has been saved successfully!');
    } catch (error) {
        console.error("Error saving user data: ", error);
        alert('There was an error saving your information.');
    }
  });

  // Save "Course of Study" form
  courseStudyForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return;

    const courseData = {
        university: document.getElementById('university').value,
        program: document.getElementById('program').value,
        studyLevel: document.getElementById('study-level').value,
        intake: document.getElementById('intake').value,
        applicationStatus: document.getElementById('application-status').value,
    };

    try {
        await setDoc(doc(db, "users", currentUser.uid), courseData, { merge: true });
        alert('Course information has been saved successfully!');
    } catch (error) {
        console.error("Error saving course data: ", error);
        alert('There was an error saving your information.');
    }
  });


  // --- FILE UPLOAD LOGIC ---
  document.querySelectorAll('.document-upload-item').forEach(item => {
    const uploadButton = item.querySelector('button');
    const fileInput = item.querySelector('input[type="file"]');
    
    uploadButton.addEventListener('click', async () => {
        const file = fileInput.files[0];
        if (!file || !currentUser) {
            alert("Please select a file to upload.");
            return;
        }

        uploadButton.disabled = true;
        uploadButton.textContent = 'Uploading...';

        const category = item.dataset.category;
        const docName = item.dataset.docName;
        const storageRef = ref(storage, `user-documents/${currentUser.uid}/${category}/${docName}_${file.name}`);
        
        try {
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            
            // Save metadata to Firestore
            const docData = {
                name: file.name,
                url: downloadURL,
                category: category,
                docType: docName,
                uploadedAt: new Date()
            };
            await addDoc(collection(db, "users", currentUser.uid, "documents"), docData);

            alert('File uploaded successfully!');
            loadUserFiles(item); // Refresh file list for this item
            fileInput.value = ''; // Clear the input
        } catch (error) {
            console.error("Upload failed:", error);
            alert("Error uploading file.");
        } finally {
            uploadButton.disabled = false;
            uploadButton.textContent = 'Upload';
        }
    });
  });

  // --- FILE LISTING LOGIC ---
  async function loadUserFiles(item) {
    if (!currentUser) return;
    const fileListContainer = item.querySelector('.uploaded-file-list');
    fileListContainer.innerHTML = '<span>Loading...</span>';

    const category = item.dataset.category;
    const docName = item.dataset.docName;
    
    try {
        const q = query(collection(db, "users", currentUser.uid, "documents"), where("docType", "==", docName));
        const querySnapshot = await getDocs(q);

        fileListContainer.innerHTML = ''; // Clear list
        if (querySnapshot.empty) {
            fileListContainer.innerHTML = '<span>No file uploaded.</span>';
        } else {
             querySnapshot.forEach((doc) => {
                const fileData = doc.data();
                const a = document.createElement('a');
                a.href = fileData.url;
                a.textContent = fileData.name;
                a.target = '_blank';
                a.className = 'uploaded-file-link';
                fileListContainer.appendChild(a);
            });
        }
    } catch (error) {
        console.error("Error listing files:", error);
        fileListContainer.innerHTML = '<span>Could not load file.</span>';
    }
  }

  function loadAllUserFiles() {
      document.querySelectorAll('.document-upload-item').forEach(item => {
          loadUserFiles(item);
      });
  }

  // --- HELPER FUNCTIONS ---
  function addMiddleNameInput(value = '') {
      const div = document.createElement('div');
      div.className = 'form-group col-md-6';
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control middle-name-input';
      input.placeholder = 'Middle Name';
      input.value = value;
      div.appendChild(input);
      middleNamesContainer.appendChild(div);
  }

  addMiddleNameBtn.addEventListener('click', () => addMiddleNameInput());

</script>

<!-- THEME TOGGLE AND PORTAL NAVIGATION SCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Theme Toggler
    const themeToggler = document.getElementById('theme-toggler');
    const darkThemeStyle = document.getElementById('dark-theme-style');
    const themeIcon = themeToggler ? themeToggler.querySelector('i') : null;

    const setTheme = (isDark) => {
        if (darkThemeStyle) darkThemeStyle.disabled = !isDark;
        document.body.classList.toggle('dark-mode', isDark);
        if (themeIcon) {
            themeIcon.classList.toggle('fa-sun', isDark);
            themeIcon.classList.toggle('fa-moon', !isDark);
        }
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };

    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    if (savedTheme === 'dark' || (savedTheme === null && prefersDark)) {
        setTheme(true);
    } else {
        setTheme(false);
    }

    if (themeToggler) {
        themeToggler.addEventListener('click', () => {
            const isDark = darkThemeStyle ? !darkThemeStyle.disabled : document.body.classList.contains('dark-mode');
            setTheme(!isDark);
        });
    }

    // Portal Navigation
    const navLinks = document.querySelectorAll('.portal-nav a');
    const contentSections = document.querySelectorAll('.portal-content-section');

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            if (this.id !== 'logout-btn') e.preventDefault();
            const targetId = this.getAttribute('data-target');
            if (!targetId) return;

            navLinks.forEach(navLink => navLink.parentElement.classList.remove('active'));
            this.parentElement.classList.add('active');

            contentSections.forEach(section => {
                section.classList.toggle('active', section.id === targetId);
            });
            
            // Lazy load documents
            if (targetId === 'documents-section') {
                // The loadAllUserFiles function is called by the Firebase onAuthStateChanged listener
                // so we don't need to call it again here unless we want to force a refresh.
            }
        });
    });

    // --- Populate Country Dropdowns ---
    const countrySelects = [document.getElementById('nationality'), document.getElementById('country')];
    const countryCodeSelect = document.getElementById('country-code');
    
    if(typeof countries !== 'undefined') {
        countrySelects.forEach(select => {
            if(select) {
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    select.appendChild(option);
                });
            }
        });
    }

    if(countryCodeSelect && typeof countryCodes !== 'undefined') {
        countryCodes.forEach(item => {
            const option = document.createElement('option');
            option.value = item.code;
            option.textContent = `${item.name} (${item.code})`;
            countryCodeSelect.appendChild(option);
        });
    }
});
</script>
</body>
</html>
